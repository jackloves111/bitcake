# qb-web 前端交互与后端接口实现说明（基于 dist-qbweb 构建产物）

## 概览
本说明基于构建产物目录 [dist-qbweb](file:///f:/下载/bitcake/dist-qbweb/public) 进行分析，目标是解释 qb 下载器（qBittorrent Web UI 的前端实现）如何完成：
- 右键菜单与批量选择操作（暂停、开始、删除、强制校验等）
- 设置项的读取与保存，以及与后端交互的数据流
- 后端交互成功后的前端状态刷新与结果展示

该前端为单页应用（SPA），入口文件为 [index.html](file:///f:/下载/bitcake/dist-qbweb/public/index.html)，加载两组打包脚本：
- 业务脚本：[app.93227a04.js](file:///f:/下载/bitcake/dist-qbweb/public/js/app.93227a04.js)
- 依赖脚本：[chunk-vendors.0d27978f.js](file:///f:/下载/bitcake/dist-qbweb/public/js/chunk-vendors.0d27978f.js)

额外包含 PWA 相关资源（Workbox v4 系列脚本）和样式/字体资源（Material Design Icons、Roboto）。构建产物为压缩与混淆后的代码，以下实现流程为结合该产物结构与 qBittorrent Web API v2 的常规交互方式进行的工程级推断与归纳。

## 构建产物结构与运行时
- 入口与根容器：在 [index.html](file:///f:/下载/bitcake/dist-qbweb/public/index.html) 中定义 `<div id="app"></div>` 作为根挂载点：

```html
<!DOCTYPE html>
<html>
  <head>
    <meta name="description" content="qBittorrent Web UI">
    <title>qBittorrent Web UI</title>
    <link href="css/app.3c184c49.css" rel="stylesheet">
    <link href="css/chunk-vendors.1704cb73.css" rel="stylesheet">
  </head>
  <body>
    <div id="app"></div>
    <script src="js/chunk-vendors.0d27978f.js"></script>
    <script src="js/app.93227a04.js"></script>
  </body>
</html>
```

- 前端技术栈（根据产物特征推断）：
  - 框架：Vue（或类似）SPA
  - UI：Material Design Icons 字体、CSS 打包，常见是 Vuetify/自定义组件
  - 网络：常见方案为 `fetch/axios` 调用 qBittorrent Web API v2
  - PWA：使用 Workbox v4，见 [service-worker.js](file:///f:/下载/bitcake/dist-qbweb/public/service-worker.js)

## 身份认证与会话
qBittorrent Web API v2 的典型模式是基于 Cookie 会话：
- 登录接口：`POST /api/v2/auth/login`，表单参数 `username` / `password`
- 登出接口：`POST /api/v2/auth/logout`
- 会话维持：后端返回 `SID` Cookie；后续请求携带该 Cookie 完成鉴权

前端登录页面位于 [login.html](file:///f:/下载/bitcake/dist-qbweb/public/login.html)，通常登录成功后重定向到应用根页并初始化数据轮询。

示例（curl）：

```bash
curl -i -X POST 'http://<host>:<port>/api/v2/auth/login' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data 'username=admin&password=adminadmin'
```

## 数据获取与刷新（主数据轮询）
前端通常通过「主数据同步」端点拉取 torrent 列表、分类、标签及传输状态：
- 主数据端点：`GET /api/v2/sync/maindata`（可附带 `rid` 增量标识）
- 响应包含：`torrents`（哈希为键）、`categories`、`tags`、`server_state` 等
- 刷新策略：定时轮询（如 1–3 秒），或在执行操作成功后短暂加速一次刷新

示例：

```bash
curl 'http://<host>:<port>/api/v2/sync/maindata'
```

前端会将 `torrents` 映射到表格/列表组件，作为右键与批量操作的选择来源。

## 右键菜单与批量操作流程
右键或批量操作的标准交互链路如下：
1. 列表选择
   - 单选：直接点击行高亮
   - 多选：Shift/Ctrl（或复选框列）实现范围与累加选择
   - 选择集：维护所选 torrent 的 `hash` 数组
2. 触发菜单
   - 右键在行上触发 `contextmenu`，打开上下文菜单组件
   - 菜单项：暂停、开始、强制开始、删除、重新校验、限速、顺序下载、置顶队列等
3. 调用后端 API（批量）
   - 端点统一接收 `hashes` 参数，多个哈希以 `|` 管道符拼接
   - 常用端点（POST，`Content-Type: application/x-www-form-urlencoded`）：
     - 暂停：`/api/v2/torrents/pause`
     - 开始：`/api/v2/torrents/resume`
     - 强制开始：`/api/v2/torrents/setForceStart`（`value=true/false`）
     - 删除：`/api/v2/torrents/delete`（`deleteFiles=true/false`）
     - 重新校验：`/api/v2/torrents/recheck`
     - 顺序下载：`/api/v2/torrents/toggleSequentialDownload`
     - 队列置顶/置底/移动：`/api/v2/torrents/increasePrio` / `decreasePrio` / `topPrio` / `bottomPrio`
     - 设置分类/标签：`/api/v2/torrents/setCategory` / `addTags` / `removeTags`
4. 结果与刷新
   - 成功：触发一次主数据刷新（`sync/maindata`），更新表格状态（如 `state`、`progress`、`dlspeed`）
   - 失败：显示错误提示（如 Snackbar/Toast），不更新或保留原状态

批量暂停示例：

```bash
curl -X POST 'http://<host>:<port>/api/v2/torrents/pause' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data 'hashes=abcdef1234567890|1122334455667788|9988776655443322'
```

批量开始示例：

```bash
curl -X POST 'http://<host>:<port>/api/v2/torrents/resume' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data 'hashes=abcdef1234567890|1122334455667788'
```

删除（可选是否删除数据）：

```bash
curl -X POST 'http://<host>:<port>/api/v2/torrents/delete' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data 'hashes=abcdef1234567890|1122334455667788&deleteFiles=true'
```

## 设置项与后端交互
设置类页面通常涉及「读取当前偏好」与「提交更新」两个动作：
- 读取偏好：`GET /api/v2/app/preferences`，返回 JSON 包含下载目录、限速、是否启用顺序下载、WebUI 选项等
- 保存偏好：`POST /api/v2/app/setPreferences`，`json` 字段包含部分键值（增量更新）

读取示例：

```bash
curl 'http://<host>:<port>/api/v2/app/preferences'
```

保存示例（修改下载目录与限速）：

```bash
curl -X POST 'http://<host>:<port>/api/v2/app/setPreferences' \
  -H 'Content-Type: application/x-www-form-urlencoded' \
  --data-urlencode 'json={"save_path":"/data/downloads","dl_limit":5242880,"up_limit":1048576}'
```

对于传输相关设置：
- 立即限速模式：`POST /api/v2/transfer/toggleSpeedLimitsMode`
- 设置全局限速：`POST /api/v2/transfer/uploadLimit` / `downloadLimit`
- 获取当前限速：`GET /api/v2/transfer/info`

## 前端状态更新与反馈
- 状态源：主数据刷新（`sync/maindata`）返回的 `torrents` 与 `server_state`
- 显示维度：任务状态（`state`）、速度（`dlspeed` / `upspeed`）、进度（`progress`）、大小与已下载、ETA 等
- 成功反馈：操作成功后短 Toast/Snackbar；可选批量统计（成功/失败数）
- 失败反馈：接口错误字符串或 HTTP 状态码；前端展示错误并保持原状态
- PWA 缓存：Workbox 仅用于静态资源缓存，不缓存 API 响应，避免数据陈旧

## 典型交互序列（文字版）
以「右键批量暂停」为例：
1. 用户在列表中多选若干 torrent（维护 `hashes[]`）
2. 右键某一选中行，系统展示菜单；选择「暂停」
3. 前端构造 `hashes` 字符串并 `POST /api/v2/torrents/pause`
4. 接收到 2xx 成功后，触发一次 `GET /api/v2/sync/maindata`
5. 列表根据最新数据更新为 `pausedUP/pausedDL` 等状态；弹出成功提示
6. 若后端返回错误（如权限、未知哈希），前端弹出错误提示并不中断其余已成功项

## 与 qBittorrent Web API v2 的操作对照
- 暂停：`/torrents/pause`（POST）
- 开始：`/torrents/resume`（POST）
- 强制开始：`/torrents/setForceStart`（POST，`hashes` + `value`）
- 重新校验：`/torrents/recheck`（POST）
- 删除任务：`/torrents/delete`（POST，`deleteFiles`）
- 顺序下载：`/torrents/toggleSequentialDownload`（POST）
- 优先级移动：`/torrents/increasePrio`、`decreasePrio`、`topPrio`、`bottomPrio`（POST）
- 标签与分类：`/torrents/setCategory`、`addTags`、`removeTags`（POST）
- 获取列表与状态：`/sync/maindata`（GET）
- 偏好读取与修改：`/app/preferences`（GET）、`/app/setPreferences`（POST）
- 传输信息与限速：`/transfer/info`（GET）、`/transfer/uploadLimit`、`downloadLimit`、`toggleSpeedLimitsMode`（POST）

## 可扩展与改进建议
- 自适应轮询：根据用户操作加速一次刷新，空闲时减速，降低后端压力
- 批量错误细分：对 `hashes` 批量操作返回进行分项提示，便于快速定位失败任务
- 乐观更新：在常见成功场景下先行更新 UI 状态，失败再回滚，提高交互流畅度
- 选择增强：支持「按标签/分类」快速全选，支持在筛选条件下的批量操作
- 队列/限速统一入口：右键菜单与工具栏动作保持一致的行为与提示文案
- API 层封装：统一 `POST` 表单编码与错误处理，集中维护端点路径

## 重要文件参考
- 入口页面：[index.html](file:///f:/下载/bitcake/dist-qbweb/public/index.html)
- 业务脚本（打包）：[app.93227a04.js](file:///f:/下载/bitcake/dist-qbweb/public/js/app.93227a04.js)
- 依赖脚本（打包）：[chunk-vendors.0d27978f.js](file:///f:/下载/bitcake/dist-qbweb/public/js/chunk-vendors.0d27978f.js)
- Service Worker：[service-worker.js](file:///f:/下载/bitcake/dist-qbweb/public/service-worker.js)
- 样式与字体：`public/css/*`、`public/fonts/*`

## API 修复记录（torrents.ts）
- 修复开始/暂停端点：将开始由 `/torrents/start` 更正为 `/torrents/resume`，暂停由 `/torrents/stop` 更正为 `/torrents/pause`，并统一采用表单参数 `hashes`（x-www-form-urlencoded）提交，见 [torrents.ts:startTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L785-L793) 与 [torrents.ts:stopTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L795-L803)。
- 修复删除端点参数传递：改为在请求体中传递 `hashes` 与 `deleteFiles`，见 [torrents.ts:removeTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L805-L813)。
- 统一提交校验/重公告端点参数：`/torrents/recheck`、`/torrents/reannounce` 使用表单 `hashes`，见 [torrents.ts:verifyTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L818-L826) 与 [torrents.ts:reannounceTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L828-L836)。
- 修复移动位置端点参数：`/torrents/setLocation` 使用表单 `hashes` 与 `location`，见 [torrents.ts:setTorrentLocation](file:///f:/下载/bitcake/src/api/torrents.ts#L838-L849)。
- 修复限速端点参数：`/torrents/setDownloadLimit` 与 `/torrents/setUploadLimit` 使用表单 `hashes` 与 `limit`，见 [torrents.ts:setTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L851-L867)。
- 修复文件优先级设置：`/torrents/filePrio` 改为表单 `hash`、`id`、`priority` 提交，见 [torrents.ts:setTorrents](file:///f:/下载/bitcake/src/api/torrents.ts#L851-L867)。
- 修复分类设置端点参数：`/torrents/setCategory` 使用表单 `hashes` 与 `category`，见 [torrents.ts:setTorrentCategory](file:///f:/下载/bitcake/src/api/torrents.ts#L1127-L1135)。
- 修复偏好设置字段映射：将 `start-added-torrents` 映射到 `add_paused_enabled`（取反），备用速度字段改为 `use_alt_speed_limits`、`alt_dl_speed_limit`、`alt_up_speed_limit`，见 [torrents.ts:setSession](file:///f:/下载/bitcake/src/api/torrents.ts#L1027-L1051)。

## 状态与设置显示修复
- 修复暂停状态误判：`resolveQbStatus` 现优先识别包含 `paus/stop` 的字符串，避免 `pausedDL/pausedUP` 被误判为下载/做种，见 [torrents.ts:resolveQbStatus](file:///f:/下载/bitcake/src/api/torrents.ts#L541-L571)。
- 修复限速启用标志读取：`speed-limit-down-enabled` 与 `speed-limit-up-enabled` 现基于 qBittorrent 的 `dl_limit_enabled` / `up_limit_enabled`，避免保存后立即被轮询值覆盖，见 [torrents.ts:getSession](file:///f:/下载/bitcake/src/api/torrents.ts#L989-L1031)。
- 修复限速启用标志写入：保存设置时同步写入 `dl_limit_enabled` / `up_limit_enabled`，见 [torrents.ts:setSession](file:///f:/下载/bitcake/src/api/torrents.ts#L1031-L1066)。
- 修复加密策略映射：读取时将 qBittorrent 的数值型 `encryption` 反向映射为 `required/preferred/tolerated`，保持显示与保存一致，见 [torrents.ts:getSession](file:///f:/下载/bitcake/src/api/torrents.ts#L989-L1031)；保存时仍使用数值映射写入，见 [torrents.ts:setSession](file:///f:/下载/bitcake/src/api/torrents.ts#L1052-L1060)。
---
说明：由于构建产物为压缩/混淆后的代码，以上交互流程与端点对照依据 qBittorrent Web API v2 的标准用法与前端常见实现方式进行工程化复原，适用于理解与改进该前端的右键菜单、批量操作与设置交互。如需精确源码级别的命名与组件结构，建议结合 Source Map 原始源码或未压缩构建进行进一步分析。
